# Embedded Database Generator

Python script to extract data from the SQLite MAME database and create an optimized binary file for the arcade_rom_tester firmware on Raspberry Pi Pico 2.

## Requirements

- Python 3.6+
- SQLite database generated by `build_mame_database.py`

## Usage

### Standard generation

```bash
python3 generate_embedded_database.py
```

### Options

| Option | Description |
|--------|-------------|
| `-d, --database FILE` | Source SQLite database (default: `mame_roms.db`) |
| `-o, --output NAME` | Base name for output files (default: `mame_rom_database`) |
| `--min-size N` | Minimum ROM size as power of 2 (default: 11 = 2 KB) |
| `--max-size N` | Maximum ROM size as power of 2 (default: 23 = 8 MB) |
| `--bin-only` | Generate only binary file (no C files) |

### Examples

```bash
# Generate with default parameters
python3 generate_embedded_database.py

# Limit to ROMs from 4 KB to 4 MB
python3 generate_embedded_database.py --min-size 12 --max-size 22

# Generate binary only
python3 generate_embedded_database.py --bin-only
```

## Generated files

| File | Description |
|------|-------------|
| `mame_rom_database.bin` | Raw binary data |
| `include/mame_rom_database.h` | C structure definitions and macros |
| `src/mame_rom_database.c` | C array containing binary data |

## Binary format

### Header (64 bytes)

```
Offset  Size    Description
------  ----    -----------
0x00    4       Magic "MRDB"
0x04    2       Version (1)
0x06    1       min_size_pow2 (11)
0x07    1       max_size_pow2 (23)
0x08    4       ROM count
0x0C    4       Machine count
0x10    4       Machine-ROM count
0x14    4       Manufacturer count
0x18    4       ROM name count
0x1C    4       size_index table offset
0x20    4       roms table offset
0x24    4       machines table offset
0x28    4       machine_roms table offset
0x2C    4       manufacturers table offset
0x30    4       rom_names table offset
0x34    4       strings pool offset
0x38    4       descriptions pool offset
```

### Size index table (6 bytes per size)

For each `size_pow2` from 11 to 23 (13 entries):

| Field | Size | Description |
|-------|------|-------------|
| `start_index` | 3 bytes | Start index in ROMs table |
| `count` | 3 bytes | Number of ROMs of this size |

This table enables fast lookup: knowing a ROM's size, you can directly access the corresponding ROM range.

### ROMs table (23 bytes per entry)

Sorted by `size_pow2` then by `SHA1` (ascending order).

| Field | Size | Description |
|-------|------|-------------|
| `sha1` | 20 bytes | Binary SHA1 hash |
| `name_id` | 3 bytes | 24-bit ID into rom_names |

### Machines table (20 bytes per entry)

| Field | Size | Description |
|-------|------|-------------|
| `name_offset` | 4 bytes | Offset into strings pool |
| `desc_offset` | 4 bytes | Offset into descriptions pool |
| `desc_length` | 2 bytes | Compressed description length |
| `cloneof_id` | 3 bytes | 24-bit parent machine ID (0xFFFFFF = NULL) |
| `romof_id` | 3 bytes | 24-bit ROM source machine ID (0xFFFFFF = NULL) |
| `year` | 2 bytes | Release year |
| `manufacturer_id` | 2 bytes | 16-bit manufacturer ID (0xFFFF = NULL) |

### Machine-ROMs table (9 bytes per entry)

Sorted by `rom_id` to enable binary search.

| Field | Size | Description |
|-------|------|-------------|
| `machine_id` | 3 bytes | 24-bit machine ID |
| `rom_id` | 3 bytes | 24-bit ROM ID |
| `name_id` | 3 bytes | 24-bit ROM name ID in this machine |

### Manufacturers table (4 bytes per entry)

| Field | Size | Description |
|-------|------|-------------|
| `name_offset` | 4 bytes | Offset into strings pool |

### ROM names table (4 bytes per entry)

| Field | Size | Description |
|-------|------|-------------|
| `name_offset` | 4 bytes | Offset into strings pool |

### Strings pool

Concatenated NULL-terminated UTF-8 strings. Contains:
- Machine names
- Manufacturer names
- ROM file names

### Descriptions pool

Machine descriptions compressed with zlib (level 9). Data is already compressed in the source SQLite database.

## ID structure

### ROM ID (24 bits)

```
Bits 23-16: size_pow2 (8 bits)
Bits 15-0:  sequential index (16 bits)
```

This structure enables:
1. Filter by size by extracting bits 23-16
2. Binary search by SHA1 within that size range
3. Maximum 65,536 ROMs per size

### Other IDs

| Table | ID Size | NULL Value |
|-------|---------|------------|
| machines | 24 bits | 0xFFFFFF |
| machine_roms | 24 bits | 0xFFFFFF |
| rom_names | 24 bits | 0xFFFFFF |
| manufacturers | 16 bits | 0xFFFF |

## ROM lookup algorithm

To identify a ROM from its SHA1:

1. **Determine size**: Read the ROM and calculate `size_pow2 = log2(size)`

2. **Access range**: Use the `size_index` table to get `start_index` and `count`

3. **Binary search**: Within range `[start_index, start_index + count)`, perform binary search by SHA1

4. **Retrieve machines**: The found index allows constructing the `rom_id`. Search in `machine_roms` (sorted by `rom_id`) for all matching entries

5. **Display information**: For each found `machine_id`, access the `machines` table to get name, description, year, manufacturer

## Useful C macros

```c
// Read 24-bit integer
#define MRDB_READ_UINT24(ptr) \
    ((uint32_t)(ptr)[0] | ((uint32_t)(ptr)[1] << 8) | ((uint32_t)(ptr)[2] << 16))

// Extract size_pow2 from ROM ID
#define MRDB_ROM_ID_SIZE_POW2(rom_id) (((rom_id) >> 16) & 0xFF)

// Extract index from ROM ID
#define MRDB_ROM_ID_INDEX(rom_id) ((rom_id) & 0xFFFF)

// Create ROM ID
#define MRDB_MAKE_ROM_ID(size_pow2, index) (((uint32_t)(size_pow2) << 16) | (index))
```

## Typical statistics

For a complete MAME database:

| Element | Value |
|---------|-------|
| ROMs | ~157,000 |
| Machines | ~49,500 |
| Machine-ROMs | ~410,000 |
| Manufacturers | ~4,200 |
| ROM names | ~162,000 |
| **Total size** | **~12.8 MB** |

## Raspberry Pi Pico 2 constraints

- Total flash: 16 MB
- Database: ~12.8 MB
- Available for firmware: ~3.2 MB

The database fits comfortably in flash, leaving enough space for firmware code.
